angular.module("app").component("customer",{templateUrl:"app/components/customer/customer.html?rev=90e9ceabf2",bindings:{customerSelected:"="},controller:["$scope","$element","$timeout","$api","$rootScope","$stateParams","$state","$uibModal",function(c,e,t,n,r,o,a,s){var l=this;function i(e,t){for(var n=0;n<e.length;n++)e[n]==t&&(e.splice(n,1),n--);return e}function d(t,e){return l.times=0,l.customerSelected=[],4==t.parents.length?l.level=4:3==t.parents.length?l.level=3:2==t.parents.length&&(l.level=2),!l.parent1.length&&angular.forEach(l.customer.core.data,function(e){var t=e.path&&e.path.split(",").length||"";0==t&&"ROOT"!=e.id?l.parent1.push(e.id):1==t&&l.parent2.push(e.id)}),$("jstree").on("changed.jstree",function(e,n){if(!l.times)if(l.times=1,l.chosen=angular.copy(n.selected),"ROOT"===t.id){var r=[];angular.forEach(l.customer.core.data,function(e){"ROOT"===e.parent&&r.push(e.id)}),l.customerSelected=r,c.$apply()}else{if(4==l.level)angular.forEach(l.parent1,function(e){i(l.chosen,e)}),angular.forEach(l.parent2,function(e){i(l.chosen,e)}),l.customerSelected=l.chosen;else if(3==l.level){r=[];angular.forEach(l.parent2,function(t){angular.forEach(n.selected,function(e){t==e&&r.push(t)})}),r=r.distinct(),l.customerSelected=r}else if(2==l.level){r=[];angular.forEach(l.parent1,function(t){angular.forEach(n.selected,function(e){t==e&&r.push(t)})}),r=r.distinct(),l.customerSelected=r}c.$apply()}}),!0}l.choice={},l.parent1=[],l.parent2=[],Array.prototype.distinct=function(){var e,t,n=this,r=[],c=n.length;for(e=0;e<c;e++){for(t=e+1;t<c;t++)n[e]===n[t]&&(t=++e);r.push(n[e])}return r},console.log("custom"),"CUSTOMER"==o.datatype?n.customer.info({project:r.Project[0]._id},function(e){l.customer={multiple:!0,checkbox:{keep_selected_style:!1},core:{data:[{id:"ROOT",parent:"#",text:"全部",state:{opened:!0},icon:!1,checkbox:!0}],check_callback:!0},conditionalselect:d,contextmenu:{items:function(e,t){var n={};return n.create={separator_before:!1,separator_after:!0,_disabled:!1,label:"新增",action:function(e){var t=$.jstree.reference(e.reference),n=t.get_node(e.reference);console.log(t,n),console.log(e.reference),s.open({size:"sm",templateUrl:"add.html",controller:["$scope","$uibModalInstance","$api",function(e,t,n){e.OnSubmit=function(){n.control.send({id:sensor.sid,uid:r.Account._id,project:sensor.project,ctrlcode:(new Hashes.SHA1).hex(e.password).toUpperCase(),command:"EMC_SWITCH",param:{mode:sensor.status.switch?"EMC_ON":"EMC_OFF"}},function(){t.close()},SweetAlert.error)},e.OnCancel=t.dismiss}]}).result.then(function(){},function(){sensor.status.switch=!sensor.status.switch}),t.create_node(n,{},"last",function(e){setTimeout(function(){t.edit(e)},0)})}},"0001"!=e.id&&(n.delete={separator_before:!1,icon:!1,separator_after:!1,_disabled:!1,label:"删除",action:function(e){var t=$.jstree.reference(e.reference),n=t.get_node(e.reference);t.is_selected(n)?t.delete_node(t.get_selected()):t.delete_node(n)}},n.rename={separator_before:!1,separator_after:!1,_disabled:!1,label:"重命名",action:function(e){console.log(e);var t=$.jstree.reference(e.reference),n=t.get_node(e.reference);t.edit(n)}},n.binding={separator_before:!1,separator_after:!1,_disabled:!1,label:"绑定仪表",action:function(e){var t=$.jstree.reference(e.reference),n=t.get_node(e.reference);t.edit(n)}}),n}},plugins:["search","conditionalselect","contextmenu","checkbox","changed"]},function n(e,r){angular.forEach(e,function(e,t){e.parent=r,e.text=e.title,Object.keys(e.child).length,e.icon=!1,n(e.child,e.id),l.customer.core.data.push(e)})}(e.result,"ROOT"),console.log(l.customer,1)}):"/monitor"==a.current.url?n.customer.info({project:r.Project[0]._id},function(e){l.customer={core:{data:[{id:"ROOT",parent:"#",text:"全部",state:{opened:!0,selected:!0},icon:!1}],check_callback:!0},conditionalselect:d,plugins:["search","conditionalselect","checkbox","changed"]},function n(e,r){angular.forEach(e,function(e,t){e.parent=r,e.text=e.title,Object.keys(e.child).length,e.icon=!1,n(e.child,e.id),l.customer.core.data.push(e)})}(e.result,"ROOT"),console.log(l.customer,2)}):n.eca.info({projectid:r.Project[0]._id,type:o.datatype||"BYITEM"},function(e){l.customer={multiple:!0,checkbox:{keep_selected_style:!1},core:{data:[{id:"ROOT",parent:"#",text:"全部",state:{opened:!0},icon:!1}],check_callback:!0},conditionalselect:d,contextmenu:{items:function(e,t){var n={};return n.create={separator_before:!1,separator_after:!0,_disabled:!1,label:"新增",action:function(e){var t=$.jstree.reference(e.reference),n=t.get_node(e.reference);console.log(e.reference),t.create_node(n,{},"last",function(e){setTimeout(function(){t.edit(e)},0)})}},"0001"!=e.id&&(n.delete={separator_before:!1,icon:!1,separator_after:!1,_disabled:!1,label:"删除",action:function(e){var t=$.jstree.reference(e.reference),n=t.get_node(e.reference);t.is_selected(n)?t.delete_node(t.get_selected()):t.delete_node(n)}},n.rename={separator_before:!1,separator_after:!1,_disabled:!1,label:"重命名",action:function(e){console.log(e);var t=$.jstree.reference(e.reference),n=t.get_node(e.reference);t.edit(n)}},n.binding={separator_before:!1,separator_after:!1,_disabled:!1,label:"绑定仪表",action:function(e){var t=$.jstree.reference(e.reference),n=t.get_node(e.reference);t.edit(n)}}),n}},plugins:["search","conditionalselect","contextmenu","checkbox","changed"]},function n(e,r){angular.forEach(e,function(e,t){e.parent=r,e.text=e.title,Object.keys(e.child).length,e.icon=!1,n(e.child,e.id),l.customer.core.data.push(e)})}(e.result,"ROOT"),console.log(l.customer,3)})}]});