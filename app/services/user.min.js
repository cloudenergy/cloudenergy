"use strict";angular.module("app").service("User",["$rootScope","$q","$api","$storage","MENUCONFIG",function(u,o,c,s,r){var a={};angular.extend(u.User=this,{data:void 0,$account:function(e){var t=o.defer();return c.account.info(e||{id:s.get("uid")},function(e){e.result&&Object.keys(e.result).length?(u.Account=e.result,function r(e,n,o){angular.forEach(e,function(e,t){"leaf"!==t&&(e.leaf?(n[t]=!0,u.Rule.$state[o.concat([t]).join(".")]=!0):(1<o.length&&(u.Rule.$state[o.concat([t]).join(".")]=!0),r(e,n[t]=n[t]||{},o.concat([t]))))})}(u.Account.character.rule["/"],u.Rule={$state:{}},[]),angular.forEach(r,function(e){(e.ignore||u.Rule.$state[e.state])&&this.push(e)},u.Menu=[]),t.resolve(u.Account)):t.reject(e)},t.reject),t.promise},$project:function(e){return c.project.info(angular.extend({id:sessionStorage.projectid||void 0},e||{}),function(e){u.Project=angular.isArray(e.result)&&e.result||e.result&&[e.result]||[],angular.forEach(u.Project,function(e){this.push(e._id),u.Project[e._id]=e},u.Project.ids=[]),u.Project.current=u.Project[0],document.title=u.siteTitle=u.Project.current.title},function(){}).$promise},$userinfo:function(e){var t=o.defer();return c.business.userinfo(e||{},function(e){angular.extend(a,e.result),a.groupmode=!1,o.all([u.User.$account(),u.User.$project()]).then(function(){u.User.data=a,angular.forEach(r,function(e){a.groupmode?e.groupmode&&(this[e.state]=!0,this.push(e)):(this[e.state]=!0,this.push(e))},u.menuData=[]),delete angular.copy(a).character.rule,t.resolve(a)},t.reject)},t.reject),t.promise},$login:function(e){e=e||{};var t=o.defer(),r=Object.keys(e).length,n=e.remember;return delete e.remember,c.auth.login(e,function(e){a=e.result,r&&s.set(a,n),u.User.$userinfo().then(function(){t.resolve(a)},function(e){s.set(null),t.reject(e)})},t.reject),t.promise},$logout:function(e){return c.auth.logout(e||{},function(){delete u.User.data,delete sessionStorage.projectid,s.set(null)}).$promise}})}]);