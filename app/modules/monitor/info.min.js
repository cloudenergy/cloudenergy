"use strict";angular.module("app").controller("monitorInfo",["$rootScope","$scope","$q","$api","$uibModal","$state","SweetAlert",function(s,c,e,l,o,t,d){var n="sensor_index_search",i="sensor_building_selected";c.exception=[{status:void 0,name:"全部"},{status:1,name:"异常"}],c.exception.selected=c.exception.selected||(c.exception[0]||{}).id,l.device.type({project:s.Project[0]._id},function(e){c.deviceType=[],angular.forEach(e.result,function(e){"ENERGYMETER"!==e.id&&"TEMPERATURECONTROL"!==e.id&&"TIMERMETER"!==e.id||c.deviceType.push(e)}),angular.forEach(e.result,function(e){"ENERGYMETER"!==e.id&&"TEMPERATURECONTROL"!==e.id&&"TIMERMETER"!==e.id&&c.deviceType.push(e)}),c.deviceSelected=c.deviceType[0].id,c.deviceType.length&&(c.deviceType.select=function(e){delete c.multiCheck.all,c.deviceType.selected=e,c.list()})(c.deviceType[0])}),c.selectDevice=function(e){c.deviceSelected=e.id,c.OnSearch()},c.multiCheck=function(e){"all"===e?(c.multiCheck.all&&(c.showButton=!0),!c.multiCheck.all&&(c.showButton=!1),angular.forEach(c.viewOfSensor,function(e){e.isSelected=c.multiCheck.all})):(c.multiCheck.all=!0,c.showButton=!1,angular.forEach(c.viewOfSensor,function(e){e.isSelected||delete c.multiCheck.all,e.isSelected&&(c.showButton=!0)}))},c.switchControl=function(c){o.open({size:"sm",templateUrl:"switch_control.html",controller:["$scope","$uibModalInstance","$api",function(e,t,n){e.OnSubmit=function(){n.control.send({id:c.sid,uid:s.Account._id,project:c.project,ctrlcode:(new Hashes.SHA1).hex(e.password).toUpperCase(),command:"EMC_SWITCH",param:{mode:c.status.switch?"EMC_ON":"EMC_OFF"}},function(){t.close()},d.error)},e.OnCancel=t.dismiss}]}).result.then(function(){},function(){c.status.switch=!c.status.switch})},c.switchControlAll=function(c){o.open({size:"sm",templateUrl:"switch_control.html",controller:["$scope","$uibModalInstance","$api",function(t,e,n){t.OnSubmit=function(){n.control.send({id:sensor.sid,uid:s.Account._id,project:sensor.project,ctrlcode:(new Hashes.SHA1).hex(t.password).toUpperCase(),command:"EMC_SWITCH",param:{mode:c?"EMC_ON":"EMC_OFF"}},function(){e.close()},d.error)},angular.forEach(t.viewOfSensor,function(e){t.OnSubmit()}),t.OnCancel=e.dismiss}]})},c.OnSearch=function(){l.business.monitor({devicetype:c.deviceSelected,building:!c.customer.enable&&c.buildings.selected||void 0,project:s.Project[0]._id,key:c.searchKey||void 0,showexception:c.exception.selected,mode:"SENSOR",usesocity:c.customer.enable||void 0,socitynode:c.customer.enable&&c.customer.selected||void 0,pageindex:c.currentPage||1,pagesize:c.pageSize},function(e){e=e.result[s.Project[0]._id],angular.forEach(e.detail,function(e){this.push(e)},c.viewOfSensor=[]),c.itemsTotal=e.paging.count})},c.currentPage=1,c.pageSize=15,c.searchKey=sessionStorage[n],c.customer={enable:!angular.isDefined(c.customer)||c.customer.enable},e.all([l.building.info({project:s.Project[0]._id},function(e){console.log(e),c.treeData=e.result.detail;var t=sessionStorage[i];c.buildings=[],angular.forEach(e.result.detail,function(e){this.push(e)},c.buildings),c.$watch("buildings.selected",function(){console.log("watch : "+c.buildings.selected),sessionStorage[i]=c.buildings.selected,c.OnSearch()}),angular.forEach(c.buildings,function(e){e.id===t&&(c.buildings.selected=e.id)}),c.buildings.selected=c.buildings.selected||(c.buildings[0]||{}).id},function(){c.buildings=[]}).$promise,l.collector.info({project:s.Project[0]._id},function(e){c.customer=e.result.detail}),l.device.type({project:s.Project[0]._id},function(e){c.DeviceTypes=[{id:void 0,title:"全部设备"}],angular.forEach(e.result,function(e){this.push({id:e.id,title:e.name})},c.DeviceTypes),c.DeviceTypes.selected=c.DeviceTypes.selected||(c.DeviceTypes[0]||{}).id,c.DeviceTypes.select=function(){c.OnSearch()}},function(){c.DeviceTypes=[{id:void 0,title:"全部设备"}]}).$promise]).then(c.OnSearch,function(){c.viewOfSensor=[],c.itemsTotal=0}),c.$watch("currentPage",function(){c.viewOfSensor&&c.OnSearch()}),c.$watch("customer.enable",function(){c.viewOfSensor&&c.OnSearch()}),c.$watch("searchKey",function(e){angular.isDefined(e)&&(sessionStorage[n]=e)}),c.OnMask=function(e){l.sensorchannel.update({id:e.id,mask:!e.mask},function(){e.mask=!e.mask})},c.OnMaskAll=function(t){confirm("是否确定"+(t?"屏蔽":"启用")+"所有通道？")&&angular.forEach(c.viewOfSensor,function(e){e.isSelected&&angular.forEach(e.channels,function(e){l.sensorchannel.update({id:e.id,mask:t},function(){e.mask=t})})})},c.OnSyncAll=function(){confirm("是否确定同步所有数据异常的智能仪表？")&&l.sensorchannel.syncdata({project:s.Project[0]._id},function(){d.success("同步完成"),c.OnSearch()})},c.onRemove=function(e){l.sensorchannel.delete({id:e.id},function(){c.OnSearch()},d.error)},c.OnSensorAttribute=function(t){o.open({templateUrl:"sensorAttribute.html",controller:"sensorAttribute",size:"lg",resolve:{SensorSUID:function(){var e=function(n){if(!n||!n.length)return null;var c={};return _.map({buildingID:10,gatewayID:2,addrID:12,meterID:3,funcID:2},function(e,t){c[t]=n.substr(0,e),n=n.substr(e)}),c}(t.id);return e?e.buildingID+e.gatewayID+e.addrID+e.meterID:null},ProjectID:function(){return s.Project[0]._id}}}).result.then(function(){},function(){})},c.importSensor=function(){var a=c,r=!1;o.open({templateUrl:"importSensor.html",size:"md",controller:["$scope","$timeout","$uibModalInstance","project","building","customer",function(e,t,n,c,o,i){e.wifi={show:!1,equipments:""},e.actionURL="/api/import/equipments",e.project=c,e.building=o,e.customer=i,e.ok=function(){n.close(),e.wifi.show?l.project.bindequipment({projectid:s.Project[0]._id,equipments:e.wifi.equipments},function(){a.OnSearch()}):r&&a.OnSearch()},e.OnUploadComplete=function(e){return e.code?d.error(e.result,e.message):(r=!0,d.success("导入成功")),!1},e.cancel=n.dismiss}],resolve:{project:function(){return s.Project[0]._id},building:function(){return c.buildings.selected},customer:function(){return c.customer.selected}}})},c.exportSensor=function(){delete c.downloadFile,l.export.equipments({projectid:s.Project[0]._id},function(e){e.result.fn&&(c.downloadFile=e.result.fn,c.downloadName=s.Project.selected.title+"_"+t.$current.data.title)})},c.accountChange=function(n,e){o.open({size:"sm",templateUrl:{title:"titleChange.html",tag:"tagChange.html",comi:"comiChange.html"}[e],controller:["$scope","$uibModalInstance",function(e,t){e.sensor=angular.copy(n),e.sensor.did=e.sensor.id,e.title=e.sensor.title,e.tag=e.sensor.tag,e.comi=e.sensor.comi,e.ok=function(){e.sensor.projectid=s.Project[0]._id,l.sensor.update(e.sensor,function(){angular.extend(n,e.sensor),d.success("更新成功")},d.error),e.OnCancel=t.dismiss("cancel")},e.cancel=function(){e.OnCancel=t.dismiss("cancel")}}]})},c.popIsOpen=function(){angular.forEach(c.viewOfSensor,function(e){delete e.titleIsOpen,delete e.tagIsOpen,delete e.comiIsOpen})},c.popover={url:{title:"titleChange.html",tag:"tagChange.html",comi:"comiChange.html"},title:{title:"仪表名称修改",tag:"仪表编码修改",comi:"倍率修改"},ok:function(e,t,n){e[t+"IsOpen"]=!1,c.sensor=angular.copy(e),c.sensor.projectid=s.Project[0]._id,c.sensor.did=c.sensor.id,c.sensor[t]=n[t],l.sensor.update(c.sensor,function(){e[t]=n[t],d.success("更新成功")},d.error)},cancel:function(e,t){e[t+"IsOpen"]=!1}}}]),angular.module("app").component("tree",{templateUrl:"app/modules/analyse/tree.html?rev=80880b1162",bindings:{data:"<",inputChecked:"="},controller:["$api","$scope","$rootScope","$state","$q","$stateParams","$timeout","$element",function(e,t,n,c,o,i,a,r){var s=this,l=n.Project[0]._id;s.tree=[];var d=document.getElementsByClassName("treeInputAll"),u=document.getElementsByClassName("treeInput2"),p=document.getElementsByClassName("treeInput3"),m=document.getElementsByClassName("treeInput4");s.inputChecked=[],s.treeInputDisabled=function(e){switch(e){case"treeInputAll":break;case"treeInput2":for(var t=0;t<u.length;t++){if(u[t].checked){s.treeInput2Checked=!0;break}s.treeInput2Checked=!1}break;case"treeInput3":for(t=0;t<p.length;t++){if(p[t].checked){s.treeInput2Checked=!0,s.treeInput3Checked=!0;break}s.treeInput3Checked=!1}break;case"treeInput4":for(t=0;t<m.length;t++){if(m[t].checked){s.treeInput2Checked=!0,s.treeInput3Checked=!0,s.treeInput4Checked=!0;break}s.treeInput4Checked=!1}}},s.checkedPush=function(e,t){switch(s.inputChecked=[],e){case"treeInputAll":d.checked&&(s.inputChecked=[]);break;case"treeInput2":for(var n=0;n<u.length;n++)u[n].checked&&s.inputChecked.push(u[n].value);break;case"treeInput3":for(n=0;n<p.length;n++)p[n].checked&&s.inputChecked.push(p[n].value);break;case"treeInput4":for(n=0;n<m.length;n++)m[n].checked&&s.inputChecked.push(m[n].value)}},s.clickAdd=function(e){s.treeAddEacTit="",s.treeAddEacType="BYITEM",s.treeAddEacKey="",s.treeAddEacFormula="",s.treeAddEacEnable=!0,s.treeAddParent=e,$("#addModal").modal("show")},s.addEca=function(){e.eca.update({projectid:l,method:"ADD",node:{key:s.treeAddEacKey,title:s.treeAddEacTit,type:s.treeAddEacType,formula:{formula:s.treeAddEacFormula},enable:s.treeAddEacEnable,parent:s.treeAddParent}},function(e){s.dataUp(),$("#addModal").modal("hide")})},s.clickUpData=function(e){s.treeUpDataEacKey=e.key,s.treeUpDataEacOldTit=e.title,s.treeUpDataEacTit=e.title,s.treeUpDataEacType=e.type,s.treeUpDataEacFormula=e.formula,s.treeUpDataEacEnable=e.enable,s.treeUpDataEacId=e.id,$("#upDataModal").modal("show")},s.upDataEca=function(){e.eca.update({projectid:l,method:"UPDATE",node:{key:s.treeUpDataEacKey,title:s.treeUpDataEacTit,type:s.treeUpDataEacType,formula:s.treeUpDataEacFormula,enable:s.treeUpDataEacEnable,id:s.treeUpDataEacId}},function(e){s.dataUp(),$("#upDataModal").modal("hide")})},s.clickRemove=function(e){s.treeRemoveEacKey=e.key,s.treeRemoveEacTit=e.title,s.treeRemoveEacType=e.type,s.treeRemoveEacFormula=e.formula,s.treeRemoveEacEnable=e.enable,s.treeRemoveEacId=e.id,$("#removeModal").modal("show")},s.removeEca=function(){e.eca.update({projectid:l,method:"REMOVE",node:{key:s.treeRemoveEacKey,title:s.treeRemoveEacTit,type:s.treeRemoveEacType,formula:s.treeRemoveEacFormula,enable:s.treeRemoveEacEnable,id:s.treeRemoveEacId}},function(e){s.dataUp(),$("#removeModal").modal("hide")})},s.dataUp=function(){e.eca.info({projectid:n.Project[0]._id,type:i.datatype||"BYITEM"},function(e){s.data=e.result})}}]});