"use strict";angular.module("app").controller("monitorInfo",["$rootScope","$scope","$q","$api","$uibModal","$state","SweetAlert",function(l,i,e,u,o,n,a){var t="sensor_index_search",c="sensor_building_selected";i.exception=[{status:void 0,name:"全部"},{status:1,name:"异常"}],i.exception.selected=i.exception.selected||(i.exception[0]||{}).id,u.device.type({project:l.Project[0]._id},function(e){i.deviceType=[],angular.forEach(e.result,function(e){"ENERGYMETER"!==e.id&&"TEMPERATURECONTROL"!==e.id&&"TIMERMETER"!==e.id||i.deviceType.push(e)}),angular.forEach(e.result,function(e){"ENERGYMETER"!==e.id&&"TEMPERATURECONTROL"!==e.id&&"TIMERMETER"!==e.id&&i.deviceType.push(e)}),i.deviceSelected=i.deviceType[0].id,i.deviceType.length&&(i.deviceType.select=function(e){delete i.multiCheck.all,i.deviceType.selected=e,i.list()})(i.deviceType[0])}),i.selectDevice=function(e){i.deviceSelected=e.id,i.OnSearch()},i.multiCheck=function(e){"all"===e?(i.multiCheck.all&&(i.showButton=!0),!i.multiCheck.all&&(i.showButton=!1),angular.forEach(i.viewOfSensor,function(e){e.isSelected=i.multiCheck.all})):(i.multiCheck.all=!0,i.showButton=!1,angular.forEach(i.viewOfSensor,function(e){e.isSelected||delete i.multiCheck.all,e.isSelected&&(i.showButton=!0)}))},i.switchControl=function(i){o.open({size:"sm",templateUrl:"switch_control.html",controller:["$scope","$uibModalInstance","$api",function(e,n,t){e.OnSubmit=function(){t.control.send({id:i.sid,uid:l.Account._id,project:i.project,ctrlcode:(new Hashes.SHA1).hex(e.password).toUpperCase(),command:"EMC_SWITCH",param:{mode:i.status.switch?"EMC_ON":"EMC_OFF"}},function(){n.close()},a.error)},e.OnCancel=n.dismiss}]}).result.then(function(){},function(){i.status.switch=!i.status.switch})},i.switchControlAll=function(i){o.open({size:"sm",templateUrl:"switch_control.html",controller:["$scope","$uibModalInstance","$api",function(n,e,t){n.OnSubmit=function(){t.control.send({id:sensor.sid,uid:l.Account._id,project:sensor.project,ctrlcode:(new Hashes.SHA1).hex(n.password).toUpperCase(),command:"EMC_SWITCH",param:{mode:i?"EMC_ON":"EMC_OFF"}},function(){e.close()},a.error)},angular.forEach(n.viewOfSensor,function(e){n.OnSubmit()}),n.OnCancel=e.dismiss}]})},i.OnSearch=function(){u.business.monitor({devicetype:i.deviceSelected,building:!i.customer.enable&&i.buildings.selected||void 0,project:l.Project[0]._id,key:i.searchKey||void 0,showexception:i.exception.selected,mode:"SENSOR",usesocity:i.customer.enable||void 0,socitynode:i.customer.enable&&i.customer.selected||void 0,pageindex:i.currentPage||1,pagesize:i.pageSize},function(e){e=e.result[l.Project[0]._id],angular.forEach(e.detail,function(e){this.push(e)},i.viewOfSensor=[]),i.itemsTotal=e.paging.count})},i.currentPage=1,i.pageSize=15,i.searchKey=sessionStorage[t],i.customer={enable:!angular.isDefined(i.customer)||i.customer.enable},e.all([u.customer.info({project:l.Project[0]._id,onlynode:1},function(e){i.customer={enable:i.customer.enable,selected:"ROOT",core:{data:[{id:"ROOT",parent:"#",text:"全部树形结构",state:{selected:!0,opened:!0},icon:"glyphicon glyphicon-th-list"}]},conditionalselect:function(e){return i.customer.selected=e.id,i.OnSearch(),!0},plugins:["search","conditionalselect"]},function n(e,t){angular.forEach(e,function(e){e.parent=t,e.text=e.title,Object.keys(e.child).length?e.icon="glyphicon glyphicon-th-list":e.icon="glyphicon glyphicon-file",n(e.child,e.id),i.customer.core.data.push(e)})}(e.result,"ROOT")},function(){i.customer={enable:i.customer.enable,selected:"ROOT",core:{data:[{id:"ROOT",parent:"#",text:"全部树形结构",state:{selected:!0,opened:!0},icon:"glyphicon glyphicon-th-list"}]},plugins:["search","conditionalselect"]}}).$promise,u.building.info({project:l.Project[0]._id},function(e){var n=sessionStorage[c];i.buildings=[],angular.forEach(e.result.detail,function(e){this.push(e)},i.buildings),i.buildings.select=function(){sessionStorage[c]=i.buildings.selected,i.OnSearch()},angular.forEach(i.buildings,function(e){e.id===n&&(i.buildings.selected=e.id)}),i.buildings.selected=i.buildings.selected||(i.buildings[0]||{}).id},function(){i.buildings=[]}).$promise,u.device.type({project:l.Project[0]._id},function(e){i.DeviceTypes=[{id:void 0,title:"全部设备"}],angular.forEach(e.result,function(e){this.push({id:e.id,title:e.name})},i.DeviceTypes),i.DeviceTypes.selected=i.DeviceTypes.selected||(i.DeviceTypes[0]||{}).id,i.DeviceTypes.select=function(){i.OnSearch()}},function(){i.DeviceTypes=[{id:void 0,title:"全部设备"}]}).$promise]).then(i.OnSearch,function(){i.viewOfSensor=[],i.itemsTotal=0}),i.$watch("currentPage",function(){i.viewOfSensor&&i.OnSearch()}),i.$watch("customer.enable",function(){i.viewOfSensor&&i.OnSearch()}),i.$watch("searchKey",function(e){angular.isDefined(e)&&(sessionStorage[t]=e)}),i.OnMask=function(e){u.sensorchannel.update({id:e.id,mask:!e.mask},function(){e.mask=!e.mask})},i.OnMaskAll=function(n){confirm("是否确定"+(n?"屏蔽":"启用")+"所有通道？")&&angular.forEach(i.viewOfSensor,function(e){e.isSelected&&angular.forEach(e.channels,function(e){u.sensorchannel.update({id:e.id,mask:n},function(){e.mask=n})})})},i.OnSyncAll=function(){confirm("是否确定同步所有数据异常的智能仪表？")&&u.sensorchannel.syncdata({project:l.Project[0]._id},function(){a.success("同步完成"),i.OnSearch()})},i.onRemove=function(e){u.sensorchannel.delete({id:e.id},function(){i.OnSearch()},a.error)},i.OnSensorAttribute=function(n){console.log(l.Project[0]._id),o.open({templateUrl:"sensorAttribute.html",controller:"sensorAttribute",size:"lg",resolve:{SensorSUID:function(){var e=function(t){if(!t||!t.length)return null;var i={};return _.map({buildingID:10,gatewayID:2,addrID:12,meterID:3,funcID:2},function(e,n){i[n]=t.substr(0,e),t=t.substr(e)}),i}(n.id);return e?e.buildingID+e.gatewayID+e.addrID+e.meterID:null},ProjectID:function(){return l.Project[0]._id}}}).result.then(function(){},function(){})},i.importSensor=function(){var s=i,r=!1;o.open({templateUrl:"importSensor.html",size:"md",controller:["$scope","$timeout","$uibModalInstance","project","building","customer",function(e,n,t,i,o,c){e.wifi={show:!1,equipments:""},e.actionURL="/api/import/equipments",e.project=i,e.building=o,e.customer=c,e.ok=function(){t.close(),e.wifi.show?u.project.bindequipment({projectid:l.Project[0]._id,equipments:e.wifi.equipments},function(){s.OnSearch()}):r&&s.OnSearch()},e.OnUploadComplete=function(e){return e.code?a.error(e.result,e.message):(r=!0,a.success("导入成功")),!1},e.cancel=t.dismiss}],resolve:{project:function(){return l.Project[0]._id},building:function(){return i.buildings.selected},customer:function(){return i.customer.selected}}})},i.exportSensor=function(){delete i.downloadFile,u.export.equipments({projectid:l.Project[0]._id},function(e){e.result.fn&&(i.downloadFile=e.result.fn,i.downloadName=l.Project.selected.title+"_"+n.$current.data.title)})},i.accountChange=function(t,e){o.open({size:"sm",templateUrl:{title:"titleChange.html",tag:"tagChange.html",comi:"comiChange.html"}[e],controller:["$scope","$uibModalInstance",function(e,n){e.sensor=angular.copy(t),e.sensor.did=e.sensor.id,e.title=e.sensor.title,e.tag=e.sensor.tag,e.comi=e.sensor.comi,e.ok=function(){e.sensor.projectid=l.Project[0]._id,u.sensor.update(e.sensor,function(){angular.extend(t,e.sensor),a.success("更新成功")},a.error),e.OnCancel=n.dismiss("cancel")},e.cancel=function(){e.OnCancel=n.dismiss("cancel")}}]})},i.popIsOpen=function(){angular.forEach(i.viewOfSensor,function(e){delete e.titleIsOpen,delete e.tagIsOpen,delete e.comiIsOpen})},i.popover={url:{title:"titleChange.html",tag:"tagChange.html",comi:"comiChange.html"},title:{title:"仪表名称修改",tag:"仪表编码修改",comi:"倍率修改"},ok:function(e,n,t){e[n+"IsOpen"]=!1,i.sensor=angular.copy(e),i.sensor.projectid=l.Project[0]._id,i.sensor.did=i.sensor.id,i.sensor[n]=t[n],u.sensor.update(i.sensor,function(){e[n]=t[n],a.success("更新成功")},a.error)},cancel:function(e,n){e[n+"IsOpen"]=!1}}}]);