"use strict";angular.module("app").controller("sensorAttribute",["$scope","$uibModalInstance","$q","$api","SensorSUID","ProjectID",function(t,i,e,s,n,d){function o(){return t.DriverCompany.selected&&t.DriverName.selected&&t.DriverVersion.selected?t.DriverCompany.selected.id+"/"+t.DriverName.selected.id+"/"+t.DriverVersion.selected.id:""}t.else=2,t.Ok=function(){var e=o(),r={did:n,driver:e,projectid:d,ext:t.SensorAttrib.ext||{},title:t.sensorInfo.title,tag:t.sensorInfo.tag,freq:t.sensorInfo.freq,comi:t.sensorInfo.comi,areaid:t.sensorInfo.areaid,addrid:t.sensorInfo.addrid,meterid:t.sensorInfo.meterid};r.ext.adaptdevice=t.extDevice||"",s.sensor.update(r,function(){i.close()})},t.Cancel=function(){i.dismiss("cancel")},t.$watch("DriverCompany.selected",function(e){if(e){if(t.AdaptDevice&&(t.AdaptDevice=[]),t.devicedrive&&(t.devicedrive=!1),t.DriverNames=t.Drivers[e.id].driver,!t.DriverNames)return;t.DriverName=[],_.map(t.DriverNames,function(e,r){t.DriverName.push({id:r})});var r=t.SensorAttrib.driver&&t.SensorAttrib.driver.split("/");t.DriverName&&(t.DriverName.selected={id:r&&r[1]})}}),t.$watch("DriverName.selected",function(e){if(e){if(t.DriverNames[e.id]&&(t.DriverVersions=t.DriverNames[e.id].driver),!t.DriverVersions)return;t.DriverVersion=[],_.map(t.DriverVersions,function(e,r){t.DriverVersion.push({id:r})});var r=t.SensorAttrib.driver&&t.SensorAttrib.driver.split("/");t.DriverVersion&&(t.DriverVersion.selected={id:r&&r[2]})}}),t.$watch("DriverVersion.selected",function(e){if(e){var r=o(),i=t.DriverCompany.selected.id+"/"+t.DriverName.selected.id+"/"+t.DriverVersion.selected.id;if(s.control.driverinfo({driver:i},function(e){e.result&&e.result.adaptdevice?(t.devicedrive=!0,t.AdaptDevice=[],angular.forEach(e.result.adaptdevice,function(e){t.AdaptDevice.push(e),t.Ada==e.code&&(t.AdaptDevice.selected=e)})):t.devicedrive=!1}),!r.length)return}}),t.$watch("AdaptDevice.selected",function(e){e&&(t.extDevice=e.code)}),e.all([s.driver.enum().$promise,s.sensor.info({project:d,did:n}).$promise]).then(function(e){if(t.Drivers=e[0].result,t.DriverCompany=[],e[1].result.ext&&e[1].result.ext.adaptdevice&&(t.Ada=String(e[1].result.ext.adaptdevice)),_.map(t.Drivers,function(e,r){t.DriverCompany.push({id:r})}),t.SensorAttrib=e[1].result,t.sensorInfo={},t.sensorInfo.title=e[1].result.title,t.sensorInfo.tag=e[1].result.tag,t.sensorInfo.freq=e[1].result.freq,t.sensorInfo.comi=e[1].result.comi,t.sensorInfo.areaid=e[1].result.areaid,t.sensorInfo.addrid=e[1].result.addrid,t.sensorInfo.meterid=e[1].result.meterid,t.SensorAttrib&&t.SensorAttrib.driver){var r=t.SensorAttrib.driver.split("/");t.DriverCompany&&(t.DriverCompany.selected={id:r[0]}),t.DriverName&&(t.DriverName.selected={id:r[1]}),t.DriverVersion&&(t.DriverVersion.selected={id:r[2]})}})}]);