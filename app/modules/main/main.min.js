angular.module("app").component("main",{templateUrl:"app/modules/main/main.html?rev=84773db766",controller:["$api","$q","$timeout","$interval","$state","$scope","$rootScope",function(i,t,e,a,o,n,r){var s=this;function c(t){var e=new Date;e.setDate(e.getDate()+t);var a=e.getFullYear(),i=e.getMonth()+1,o=e.getDate()<=9&&"0"+e.getDate()||e.getDate();return String(a)+String(i<10&&"0"+i||i)+String(o)}timeout=e(function t(){s.timeStr=moment().format("HH:mm:ss"),s.hour=s.timeStr.split(":")[0],s.minute=s.timeStr.split(":")[1],s.second=s.timeStr.split(":")[2],timeout=e(t,1e3)}),s.Day="星期"+"日一二三四五六".charAt((new Date).getDay()),s.todayDate=(new Date).getFullYear()+"-"+((new Date).getMonth()+1)+"-"+(new Date).getDate();var l=["#24CBE5","#FF9655","#6AF9C4","#64E572","#FFE556","#FF987B","#FF5690","#EB31AC","#EF76D0","#ECABF3","#9F7BF6","#8650EB","#90B2FF"];function u(t){var e=new Date(parseInt(t)).getHours();return e+=":00"}s.lastMonth=String(0==(new Date).getMonth()?(new Date).getFullYear()-1:(new Date).getFullYear())+(0==(new Date).getMonth()?"12":1==String((new Date).getMonth()).length&&"0"+String((new Date).getMonth())||String((new Date).getMonth())),s.thisMonth=String((new Date).getFullYear())+((new Date).getMonth()+1<10&&"0"+((new Date).getMonth()+1)||(new Date).getMonth()+1),s.lastthisMonth=String((new Date).getFullYear()-1)+((new Date).getMonth()+1<10&&"0"+((new Date).getMonth()+1)||(new Date).getMonth()+1),s.this={},s.last={},i.business.monthlykgce({time:s.thisMonth,project:r.Project[0]._id},function(t){t=t.result[r.Project[0]._id],s.kwhperunitarea=t.kwhperunitarea,s.kgce=t.kgce,s.kgceperunitarea=t.kgceperunitarea,i.business.monthlykgce({time:s.lastMonth,project:r.Project[0]._id},function(t){t=t.result[r.Project[0]._id],s.this.kwhperunitarea=t.kwhperunitarea,s.this.kgce=t.kgce,s.this.kgceperunitarea=t.kgceperunitarea,s.this.kwhperunitareaP=((s.kwhperunitarea-s.this.kwhperunitarea)/(s.this.kwhperunitarea||1)*100).toFixed(2),s.this.kgceP=((s.kgce-s.this.kgce)/(s.this.kgce||1)*100).toFixed(2),s.this.kgceperunitareaP=((s.kgceperunitarea-s.this.kgceperunitarea)/(s.this.kgceperunitarea||1)*100).toFixed(2),i.business.monthlykgce({time:s.lastthisMonth,project:r.Project[0]._id},function(t){t=t.result[r.Project[0]._id],s.last.kwhperunitarea=t.kwhperunitarea,s.last.kgce=t.kgce,s.last.kgceperunitarea=t.kgceperunitarea,s.last.kwhperunitareaP=((s.kwhperunitarea-s.this.kwhperunitarea)/(s.this.kwhperunitarea||1)*100).toFixed(2),s.last.kgceP=((s.kgce-s.this.kgce)/(s.this.kgce||1)*100).toFixed(2),s.last.kgceperunitareaP=((s.kgceperunitarea-s.this.kgceperunitarea)/(s.this.kgceperunitarea||1)*100).toFixed(2)})})}),i.business.monthlycost({time:s.thisMonth,project:r.Project[0]._id},function(t){s.cost=t.result[r.Project[0]._id].cost,i.business.monthlycost({time:s.lastMonth,project:r.Project[0]._id},function(t){s.this.cost=t.result[r.Project[0]._id].cost,s.this.costP=((s.cost-s.this.cost)/(s.this.cost||1)*100).toFixed(2),i.business.monthlycost({time:s.lastthisMonth,project:r.Project[0]._id},function(t){s.last.cost=t.result[r.Project[0]._id].cost,s.last.costP=((s.cost-s.last.cost)/(s.last.cost||1)*100).toFixed(2)})})}),i.business.monitor({project:r.Project[0]._id,showexception:!0,devicetype:"ELECTRICITYMETER"},function(t){s.ELECTRICITYMETER_BRO=t.result[r.Project[0]._id].paging.count}),i.business.monitor({project:r.Project[0]._id,showexception:!1,devicetype:"ELECTRICITYMETER"},function(t){s.ELECTRICITYMETER=t.result[r.Project[0]._id].paging.count}),i.business.monitor({project:r.Project[0]._id,showexception:!0,devicetype:"COLDWATERMETER"},function(t){s.COLDWATERMETER_BRO=t.result[r.Project[0]._id].paging.count}),i.business.monitor({project:r.Project[0]._id,showexception:!1,devicetype:"COLDWATERMETER"},function(t){s.COLDWATERMETER=t.result[r.Project[0]._id].paging.count}),i.business.monitor({project:r.Project[0]._id,showexception:!0,devicetype:"MELECTRICITYMETER"},function(t){s.MELECTRICITYMETER_BRO=t.result[r.Project[0]._id].paging.count}),i.business.monitor({project:r.Project[0]._id,showexception:!1,devicetype:"MELECTRICITYMETER"},function(t){s.MELECTRICITYMETER=t.result[r.Project[0]._id].paging.count}),i.collector.info({project:r.Project[0]._id},function(t){t=t.result,s.collector=t.paging.count[0].count}),s.eledata={timepoint:[],value:[]},s.waterdata={timepoint:[],value:[]},i.eca.info({projectid:r.Project[0]._id},function(t){var e=[];angular.forEach(t.result,function(t){e.push(t.id)}),i.eca.analysis({nodes:e,projectid:r.Project[0]._id,timefrom:c(0),timeto:c(0),devicetype:["ELECTRICITYMETER","MELECTRICITYMETER"],timetype:"DAY",detail:!0},function(t){data1=t.result,angular.forEach(data1,function(t){angular.forEach(t.data.usage,function(t){s.eledata.timepoint.push(u(t.timepoint)),s.eledata.value.push(t.value||0)}),s.lineDataFn()})}),i.eca.analysis({nodes:e,projectid:r.Project[0]._id,timefrom:c(0),timeto:c(0),devicetype:"COLDWATERMETER",timetype:"DAY",detail:!0},function(t){data1=t.result,angular.forEach(data1,function(t){angular.forEach(t.data.usage,function(t){s.waterdata.timepoint.push(u(t.timepoint)),s.waterdata.value.push(t.value)}),s.lineDataFn()})})}),s.lineDataFn=function(){s.linedata={tooltip:{trigger:"axis",axisPointer:{snap:!0,type:"cross",label:{backgroundColor:"#6a7985"}}},legend:{textStyle:{color:"#fff"}},grid:{top:10,bottom:"4%",left:"3%",right:10,containLabel:!0},xAxis:[{boundaryGap:!1,data:s.eledata.timepoint.length&&s.eledata.timepoint||s.waterdata.timepoint.length&&s.waterdata.timepoint,splitLine:{show:!1},axisLine:{lineStyle:{color:"rgba(255,255,255,0.6)"}},labels:{formatter:function(){return moment(this.value).format("H")}}}],yAxis:[{type:"value",splitLine:{show:!1},axisLine:{lineStyle:{color:"rgba(255,255,255,0.6)"}}}],textStyle:{color:"#fff"},series:[{name:"电",type:"line",stack:"总量",areaStyle:{normal:{}},smooth:!0,symbol:"circle",symbolSize:5,sampling:"average",itemStyle:{normal:{color:"#d68262"}},areaStyle:{normal:{color:new echarts.graphic.LinearGradient(0,1,0,0,[{offset:0,color:"rgba(255,84,0,0.1)"},{offset:1,color:"rgba(255,84,0,1)"}])}},data:s.eledata&&s.eledata.value},{name:"水",type:"line",stack:"总量",areaStyle:{normal:{}},smooth:!0,symbol:"circle",symbolSize:5,sampling:"average",itemStyle:{normal:{color:"#8ec6ad"}},areaStyle:{normal:{color:new echarts.graphic.LinearGradient(0,1,0,0,[{offset:0,color:"rgba(0,212,255,0.1)"},{offset:1,color:"rgba(0,212,255,1)"}])}},data:s.waterdata&&s.waterdata.value}]}},i.business.projectYearKGCE({projectid:r.Project[0]._id}),n.baseConfig={dataLoaded:!0},n.baseConfigRandar={dataLoaded:!0},n.baseConfigTurn={dataLoaded:!0},n.barConfig=angular.copy(n.baseConfig),n.barOption={xAxis:{type:"category",data:["01","02","03","04","05","06","07","08","09","10","11","12"],axisLine:{lineStyle:{color:"#fff"}}},yAxis:{type:"value",show:!1},grid:{top:0,bottom:40,left:0,right:0,containLabel:!0},series:[{data:[120,200,150,80,70,110,130,12,23,200,30,130],type:"bar",itemStyle:{normal:{color:"#FF6400"}}}]},n.barConfig2=angular.copy(n.baseConfig),n.barOption2={xAxis:{type:"category",data:["01","02","03","04","05","06","07","08","09","10","11","12"],axisLine:{lineStyle:{color:"#fff"}}},yAxis:{type:"value",show:!1},grid:{top:0,bottom:40,left:0,right:0,containLabel:!0},series:[{data:[120,200,150,80,70,110,130,12,23,200,30,130],type:"bar",itemStyle:{normal:{color:"#58EDCC"}}}]},n.barConfig3=angular.copy(n.baseConfig),n.barOption3={xAxis:{type:"category",data:["01","02","03","04","05","06","07","08","09","10","11","12"],axisLine:{lineStyle:{color:"#fff"}}},yAxis:{type:"value",show:!1},grid:{top:0,bottom:40,left:0,right:0,containLabel:!0},series:[{data:[120,200,150,80,70,110,130,12,23,200,30,130],type:"bar",itemStyle:{normal:{color:"#F4D140"}}}]},s.itemPie=function(a){i.eca.info({type:"BYITEM",projectid:r.Project[0]._id},function(t){var e=[];angular.forEach(t.result,function(t){e.push(t.id)}),i.eca.analysis({nodes:e,projectid:r.Project[0]._id,timefrom:c(0),timeto:c(0),timetype:a||"DAY",detail:!1},function(t){var e=[];angular.forEach(t.result,function(t){e.push({value:t.data.kgcesum,name:t.title})}),n.barOptionRandar={tooltip:{trigger:"item",formatter:"{a} <br/>{b} : {c} ({d}%)"},series:[{name:"能耗分项",type:"pie",radius:["50%","70%"],data:e,itemStyle:{emphasis:{shadowBlur:10,shadowOffsetX:0,shadowColor:"rgba(0, 0, 0, 0.5)"}},color:l}]}})})},s.itemPie(),s.categoryPie=function(a){i.eca.info({type:"BYCATEGORY",projectid:r.Project[0]._id},function(t){var e=[];angular.forEach(t.result,function(t){e.push(t.id)}),i.eca.analysis({nodes:e,projectid:r.Project[0]._id,timefrom:c(0),timeto:c(0),timetype:a||"DAY",detail:!1},function(t){var e=[];angular.forEach(t.result,function(t){e.push({value:t.data.kgcesum,name:t.title})}),n.barOptionPie={tooltip:{trigger:"item",formatter:"{a} <br/>{b} : {c} ({d}%)"},series:[{name:"能耗分类",type:"pie",radius:["50%","70%"],data:e,itemStyle:{emphasis:{shadowBlur:10,shadowOffsetX:0,shadowColor:"rgba(0, 0, 0, 0.5)"}},color:l}]}})})},s.categoryPie(),s.custom=function(){i.eca.info({projectid:r.Project[0]._id,type:"CUSTOMER"},function(t){var e=t.result;s.categoryArray=[],angular.forEach(e,function(t){s.categoryArray.push(t.id)})}).$promise.then(function(){i.eca.analysis({nodes:s.categoryArray,projectid:r.Project[0]._id,timefrom:String((new Date).getFullYear()),timeto:String((new Date).getFullYear()),detail:!1,timetype:"YEAR"},function(t){var a;s.data=t.result,angular.forEach(s.data,function(t){t.kgcesum=t.data&&t.data.kgcesum||0}),s.data=s.data.sort((a="kgcesum",function(t,e){return t[a]-e[a]})),s.data=s.data.slice(-5),s.yname=[],s.series=[],angular.forEach(s.data,function(t){s.yname.push(t.title),s.series.push(t.data&&t.data.kgcesum||0)}),s.max=s.data[s.data.length-1].data.kgcesum,n.barOptionTurn={tooltip:{trigger:"axis",axisPointer:{type:"shadow"}},grid:{top:10,left:"3%",right:"4%",bottom:"3%",containLabel:!0,y:0,y2:0},xAxis:{type:"value",boundaryGap:[0,.01],axisLine:{lineStyle:{color:"rgba(255,255,255,0)"}},splitLine:{show:!1},max:s.max},yAxis:[{type:"category",axisLabel:{interval:0},axisLine:{lineStyle:{color:"rgba(255,255,255,0)"}},data:s.yname,splitLine:{show:!1}},{type:"category",axisLine:{show:!1},axisTick:{show:!1},axisLabel:{show:!1},splitArea:{show:!1},splitLine:{show:!1},data:s.yname}],textStyle:{color:"#fff"},series:[{type:"bar",data:s.series,itemStyle:{normal:{color:"#E9603B"}}},{name:"",type:"bar",yAxisIndex:1,itemStyle:{normal:{color:"rgba(200, 200, 200,0.1)"}},data:[s.max,s.max,s.max,s.max,s.max]}]}})})},s.custom(),n.lineConfigBottom=angular.copy(n.baseConfig),n.lineOptionBottom={title:{},tooltip:{trigger:"axis"},grid:{top:20,left:"3%",right:"4%",bottom:10,containLabel:!0},xAxis:{type:"category",boundaryGap:!1,data:["一月","二月","三月","四月","五月","六月","七月"],splitLine:{show:!1},axisLine:{lineStyle:{color:"rgba(255,255,255,0.6)"}}},yAxis:{type:"value",splitLine:{show:!1},axisLine:{lineStyle:{color:"rgba(255,255,255,0.6)"}}},textStyle:{color:"#fff"},series:[{name:"去年走势",type:"line",stack:"总量",data:[120,132,101,134,90,230,210]},{name:"今年走势",type:"line",stack:"总量",data:[220,182,191,234,290,330,310]}]}}]}),angular.module("app").component("line",{templateUrl:"app/modules/main/line.html?rev=3a184e957d",bindings:{data:"<",unit:"<",chartTitle:"<"},controller:["$scope","$rootScope","$api","$interval","$timeout",function(a,t,e,i,o){var n=this;a.$watchCollection(function(){return n.data},function(){a.baseConfig={dataLoaded:!0},a.lineConfig=angular.copy(a.baseConfig),a.oldData=angular.copy(n.data),a.newData=angular.copy(n.data),a.lineHover=!0;for(var e=0,t=0;t<a.newData.series.length;t++)a.newData.series[t].data=[];a.$watch("lineHover",function(){if(a.lineHover){var t=i(function(){a.newData.series[1].data.push(a.oldData.series[1].data[e]),++e>=a.oldData.series[1].data.length-1&&i.cancel(t)},3e3);a.lineOption=a.newData}a.lineHover||(a.lineOption=n.data)})})}]});