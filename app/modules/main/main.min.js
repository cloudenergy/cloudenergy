angular.module("app").component("main",{templateUrl:"app/modules/main/main.html?rev=51414b2c2e",controller:["$api","$q","$timeout","$interval","$state","$scope","$rootScope",function(i,e,t,o,a,s,n){var c=this;function r(e){var t=new Date;t.setDate(t.getDate()+e);var a=t.getFullYear(),i=t.getMonth()+1,o=t.getDate()<=9&&"0"+t.getDate()||t.getDate();return String(a)+String(i<10&&"0"+i||i)+String(o)}timeout=t(function e(){c.timeStr=moment().format("HH:mm:ss"),c.hour=c.timeStr.split(":")[0],c.minute=c.timeStr.split(":")[1],c.second=c.timeStr.split(":")[2],timeout=t(e,1e3)}),c.Day="星期"+"日一二三四五六".charAt((new Date).getDay()),c.todayDate=(new Date).getFullYear()+"-"+((new Date).getMonth()+1)+"-"+(new Date).getDate();var l=["#24CBE5","#FF9655","#6AF9C4","#64E572","#FFE556","#FF987B","#FF5690","#EB31AC","#EF76D0","#ECABF3","#9F7BF6","#8650EB","#90B2FF"];c.lastMonth=String(0==(new Date).getMonth()?(new Date).getFullYear()-1:(new Date).getFullYear())+(0==(new Date).getMonth()?"12":1==String((new Date).getMonth()).length&&"0"+String((new Date).getMonth())||String((new Date).getMonth())),c.thisMonth=String((new Date).getFullYear())+((new Date).getMonth()+1<10&&"0"+((new Date).getMonth()+1)||(new Date).getMonth()+1),c.lastthisMonth=String((new Date).getFullYear()-1)+((new Date).getMonth()+1<10&&"0"+((new Date).getMonth()+1)||(new Date).getMonth()+1),c.this={},c.last={},i.business.monthlykgce({time:c.thisMonth,project:n.Project[0]._id},function(e){e=e.result[n.Project[0]._id],c.kwhperunitarea=e.kwhperunitarea,c.kgce=e.kgce,c.kgceperunitarea=e.kgceperunitarea,i.business.monthlykgce({time:c.lastMonth,project:n.Project[0]._id},function(e){e=e.result[n.Project[0]._id],c.this.kwhperunitarea=e.kwhperunitarea,c.this.kgce=e.kgce,c.this.kgceperunitarea=e.kgceperunitarea,c.this.kwhperunitareaP=((c.kwhperunitarea-c.this.kwhperunitarea)/(c.this.kwhperunitarea||1)*100).toFixed(2),c.this.kgceP=((c.kgce-c.this.kgce)/(c.this.kgce||1)*100).toFixed(2),c.this.kgceperunitareaP=((c.kgceperunitarea-c.this.kgceperunitarea)/(c.this.kgceperunitarea||1)*100).toFixed(2),i.business.monthlykgce({time:c.lastthisMonth,project:n.Project[0]._id},function(e){e=e.result[n.Project[0]._id],c.last.kwhperunitarea=e.kwhperunitarea,c.last.kgce=e.kgce,c.last.kgceperunitarea=e.kgceperunitarea,c.last.kwhperunitareaP=((c.kwhperunitarea-c.this.kwhperunitarea)/(c.this.kwhperunitarea||1)*100).toFixed(2),c.last.kgceP=((c.kgce-c.this.kgce)/(c.this.kgce||1)*100).toFixed(2),c.last.kgceperunitareaP=((c.kgceperunitarea-c.this.kgceperunitarea)/(c.this.kgceperunitarea||1)*100).toFixed(2)})})}),i.business.monthlycost({time:c.thisMonth,project:n.Project[0]._id},function(e){c.cost=e.result[n.Project[0]._id].cost,i.business.monthlycost({time:c.lastMonth,project:n.Project[0]._id},function(e){c.this.cost=e.result[n.Project[0]._id].cost,c.this.costP=((c.cost-c.this.cost)/(c.this.cost||1)*100).toFixed(2),i.business.monthlycost({time:c.lastthisMonth,project:n.Project[0]._id},function(e){c.last.cost=e.result[n.Project[0]._id].cost,c.last.costP=((c.cost-c.last.cost)/(c.last.cost||1)*100).toFixed(2)})})}),i.business.monitor({project:n.Project[0]._id,showexception:!0,devicetype:"ELECTRICITYMETER"},function(e){c.ELECTRICITYMETER_BRO=e.result[n.Project[0]._id].paging.count}),i.business.monitor({project:n.Project[0]._id,showexception:!1,devicetype:"ELECTRICITYMETER"},function(e){c.ELECTRICITYMETER=e.result[n.Project[0]._id].paging.count}),i.business.monitor({project:n.Project[0]._id,showexception:!0,devicetype:"COLDWATERMETER"},function(e){c.COLDWATERMETER_BRO=e.result[n.Project[0]._id].paging.count}),i.business.monitor({project:n.Project[0]._id,showexception:!1,devicetype:"COLDWATERMETER"},function(e){c.COLDWATERMETER=e.result[n.Project[0]._id].paging.count}),i.business.monitor({project:n.Project[0]._id,showexception:!0,devicetype:"MELECTRICITYMETER"},function(e){c.MELECTRICITYMETER_BRO=e.result[n.Project[0]._id].paging.count}),i.business.monitor({project:n.Project[0]._id,showexception:!1,devicetype:"MELECTRICITYMETER"},function(e){c.MELECTRICITYMETER=e.result[n.Project[0]._id].paging.count}),i.collector.info({project:n.Project[0]._id},function(e){e=e.result,c.collector=e.paging.count[0].count}),c.eledata={timepoint:[],value:[]},c.waterdata={timepoint:[],value:[]},i.eca.info({projectid:n.Project[0]._id},function(e){var t=[];angular.forEach(e.result,function(e){t.push(e.id)}),i.eca.analysis({nodes:t,projectid:n.Project[0]._id,timefrom:r(0),timeto:r(0),timetype:"DAY",detail:!0},function(e){var t=e.result;s.series=[],s.xAxisTime=[],angular.forEach(t,function(e,t){var a,i,o={},n=[],r=[];switch(e.category){case"HEATENERGYMETER":o.name="热能",a="#b3d0ec",i="179,208,236";break;case"COLDWATERMETER":o.name="冷水",a="#58edcc",i="0,212,255";break;case"HOTWATERMETER":o.name="热水",a="#ff6400",i="255,100,0";break;case"OXYGENMETER":o.name="氧气",a="#f4d140",i="244,209,64";break;case"GASMETER":o.name="燃气",a="#63e572",i="99,229,114";break;case"ELECTRICITYMETER":o.name="电气",a="#2b4d69",i="43,77,105";break;default:o.name="其他"}o.type="line",o.areaStyle={normal:{}},o.smooth=!0,o.symbol="circle",o.symbolSize=5,o.sampling="average",o.itemStyle={normal:{color:a}},o.z=t,o.areaStyle={normal:{color:new echarts.graphic.LinearGradient(0,1,0,0,[{offset:0,color:"rgba("+i+",0.1)"},{offset:1,color:"rgba("+i+",1)"}])}},angular.forEach(e.data.usage,function(e){var t,a;n.push(e.value),r.push((t=e.timepoint,a=new Date(parseInt(t)).getHours(),a+=":00"))}),o.data=n,s.xAxisTime=r,s.series.push(o),c.lineDataFn()})})}),c.lineDataFn=function(){c.linedata={tooltip:{trigger:"axis",axisPointer:{snap:!0,type:"cross",label:{backgroundColor:"#6a7985"}}},legend:{textStyle:{color:"#fff"}},grid:{top:10,bottom:"4%",left:"3%",right:10,containLabel:!0},xAxis:[{boundaryGap:!1,data:s.xAxisTime,splitLine:{show:!1},axisLine:{lineStyle:{color:"rgba(255,255,255,0.6)"}},labels:{formatter:function(){return moment(this.value).format("H")}}}],yAxis:[{type:"value",splitLine:{show:!1},axisLine:{lineStyle:{color:"rgba(255,255,255,0.6)"}}}],textStyle:{color:"#fff"},series:s.series}},i.business.projectYearKGCE({projectid:n.Project[0]._id}),s.baseConfig={dataLoaded:!0},s.baseConfigRandar={dataLoaded:!0},s.baseConfigTurn={dataLoaded:!0},s.barConfig=angular.copy(s.baseConfig),s.barOption={xAxis:{type:"category",data:["01","02","03","04","05","06","07","08","09","10","11","12"],axisLine:{lineStyle:{color:"#fff"}}},yAxis:{type:"value",show:!1},grid:{top:0,bottom:40,left:0,right:0,containLabel:!0},series:[{data:[120,200,150,80,70,110,130,12,23,200,30,130],type:"bar",itemStyle:{normal:{color:"#FF6400"}}}]},s.barConfig2=angular.copy(s.baseConfig),s.barOption2={xAxis:{type:"category",data:["01","02","03","04","05","06","07","08","09","10","11","12"],axisLine:{lineStyle:{color:"#fff"}}},yAxis:{type:"value",show:!1},grid:{top:0,bottom:40,left:0,right:0,containLabel:!0},series:[{data:[120,200,150,80,70,110,130,12,23,200,30,130],type:"bar",itemStyle:{normal:{color:"#58EDCC"}}}]},s.barConfig3=angular.copy(s.baseConfig),s.barOption3={xAxis:{type:"category",data:["01","02","03","04","05","06","07","08","09","10","11","12"],axisLine:{lineStyle:{color:"#fff"}}},yAxis:{type:"value",show:!1},grid:{top:0,bottom:40,left:0,right:0,containLabel:!0},series:[{data:[120,200,150,80,70,110,130,12,23,200,30,130],type:"bar",itemStyle:{normal:{color:"#F4D140"}}}]},c.itemPie=function(a){i.eca.info({type:"BYITEM",projectid:n.Project[0]._id},function(e){var t=[];angular.forEach(e.result,function(e){t.push(e.id)}),i.eca.analysis({nodes:t,projectid:n.Project[0]._id,timefrom:r(0),timeto:r(0),timetype:a||"DAY",detail:!1},function(e){console.log(e);var t=[],a=[],i=[];angular.forEach(e.result,function(e){t.push({value:e.data.kgcesum,name:e.title}),a.push(e.data.kgcesum),i.push({text:e.title})}),console.log(t),s.barOptionRandar={tooltip:{trigger:"item"},radar:[{indicator:i,shape:"circle",name:{textStyle:{color:"#fff"}},lineStyle:{color:"#7baee8"}}],series:[{name:"能耗分项",type:"radar",itemStyle:{emphasis:{lineStyle:{width:4}}},areaStyle:{color:"#7ebfd5"},data:[{value:a,symbol:"rect",symbolSize:5,lineStyle:{normal:{type:"dashed"}},itemStyle:{color:"#fff"}}]}]}})})},c.itemPie(),c.categoryPie=function(a){i.eca.info({type:"BYCATEGORY",projectid:n.Project[0]._id},function(e){var t=[];angular.forEach(e.result,function(e){t.push(e.id)}),i.business.dailycost({time:r(0),project:n.Project[0]._id},function(e){console.log(e)}),i.eca.analysis({nodes:t,projectid:n.Project[0]._id,timefrom:r(0),timeto:r(0),timetype:a||"DAY",detail:!0},function(e){var t=0,a=[];angular.forEach(e.result,function(e){t+=e.data.costsum,a.push({value:e.data.kgcesum,name:e.title}),angular.forEach(e.data.costsum)}),s.moneyAni=t/2;var i=o(function(){s.moneyAni+=11.11,console.log(t),s.moneyAni>=t&&(s.moneyAni=t,o.cancel(i)),s.barOptionPie={tooltip:{trigger:"item",formatter:"{a} <br/>{b} : {c} ({d}%)"},title:{x:"center",y:"center",text:["{tit1|总金额}","{tit2|"+s.moneyAni.toFixed(2)+"}","{tit3|元}"].join("\n"),textStyle:{color:"#fff",rich:{tit1:{fontSize:14},tit2:{fontSize:20},tit3:{fontSize:14}}}},series:[{name:"能耗分类",type:"pie",radius:["50%","70%"],data:a,itemStyle:{emphasis:{shadowBlur:10,shadowOffsetX:0,shadowColor:"rgba(0, 0, 0, 0.5)"}},color:l}]}},1e3)})})},c.categoryPie(),c.custom=function(){i.eca.info({projectid:n.Project[0]._id,type:"CUSTOMER"},function(e){var t=e.result;c.categoryArray=[],angular.forEach(t,function(e){c.categoryArray.push(e.id)})}).$promise.then(function(){i.eca.analysis({nodes:c.categoryArray,projectid:n.Project[0]._id,timefrom:String((new Date).getFullYear()),timeto:String((new Date).getFullYear()),detail:!1,timetype:"YEAR"},function(e){var a;c.data=e.result,angular.forEach(c.data,function(e){e.kgcesum=e.data&&e.data.kgcesum||0}),c.data=c.data.sort((a="kgcesum",function(e,t){return e[a]-t[a]})),c.data=c.data.slice(-5),c.yname=[],c.series=[],angular.forEach(c.data,function(e){c.yname.push(e.title),c.series.push(e.data&&e.data.kgcesum||0)}),c.max=c.data[c.data.length-1].data.kgcesum,s.barOptionTurn={tooltip:{trigger:"axis",axisPointer:{type:"shadow"}},grid:{top:10,left:"3%",right:"4%",bottom:"3%",containLabel:!0,y:0,y2:0},xAxis:{type:"value",boundaryGap:[0,.01],axisLine:{lineStyle:{color:"rgba(255,255,255,0)"}},splitLine:{show:!1},max:c.max},yAxis:[{type:"category",axisLabel:{interval:0},axisLine:{lineStyle:{color:"rgba(255,255,255,0)"}},data:c.yname,splitLine:{show:!1}},{type:"category",axisLine:{show:!1},axisTick:{show:!1},axisLabel:{show:!1},splitArea:{show:!1},splitLine:{show:!1},data:c.yname}],textStyle:{color:"#fff"},series:[{type:"bar",data:c.series,itemStyle:{normal:{color:"#E9603B"}}},{name:"",type:"bar",yAxisIndex:1,itemStyle:{normal:{color:"rgba(200, 200, 200,0.1)"}},data:[c.max,c.max,c.max,c.max,c.max]}]}})})},c.custom(),s.lineConfigBottom=angular.copy(s.baseConfig),s.lineOptionBottom={title:{},tooltip:{trigger:"axis"},grid:{top:20,left:"3%",right:"4%",bottom:10,containLabel:!0},xAxis:{type:"category",boundaryGap:!1,data:["一月","二月","三月","四月","五月","六月","七月"],splitLine:{show:!1},axisLine:{lineStyle:{color:"rgba(255,255,255,0.6)"}}},yAxis:{type:"value",splitLine:{show:!1},axisLine:{lineStyle:{color:"rgba(255,255,255,0.6)"}}},textStyle:{color:"#fff"},series:[{name:"去年走势",type:"line",stack:"总量",data:[120,132,101,134,90,230,210]},{name:"今年走势",type:"line",stack:"总量",data:[220,182,191,234,290,330,310]}]}}]}),angular.module("app").component("line",{templateUrl:"app/modules/main/line.html?rev=3a184e957d",bindings:{data:"<",unit:"<",chartTitle:"<"},controller:["$scope","$rootScope","$api","$interval","$timeout",function(a,e,t,i,o){var n=this;a.$watchCollection(function(){return n.data},function(){a.baseConfig={dataLoaded:!0},a.lineConfig=angular.copy(a.baseConfig);var e=i(function(){!function(){a.oldData=angular.copy(n.data),a.newData=angular.copy(n.data),a.lineHover=!0;for(var e=0;e<a.newData.series.length;e++)a.newData.series[e].data=[];a.$watch("lineHover",function(){a.lineHover&&angular.forEach(a.oldData.series,function(e,t){n["index"+t]=0,n["lineDataTime"+t]=i(function(){a.newData.series[t].data.push(e.data[n["index"+t]]),n["index"+t]++,n["index"+t]>=a.oldData.series[t].data.length&&i.cancel(n["lineDataTime"+t])},3e3),a.lineOption=a.newData}),a.lineHover||(a.lineOption=n.data)})}()},3e4);a.lineOption=n.data,a.$on("$destroy",function(){i.cancel(e)})})}]});